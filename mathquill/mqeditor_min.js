var MQeditor=function(e){var t={layoutstyle:"auto",layout:[]},a={},s=!1,n=null,o=null,r=null,l=MathQuill.getInterface(MathQuill.getInterface.MAX),i=["alpha","beta","chi","delta","epsilon","gamma","varphi","phi","psi","sigma","rho","theta","lambda","mu","nu","omega","tau"];function c(){try{return window.self!==window.top}catch(e){return!0}}function d(s,n,o){"string"==typeof s&&(s=document.getElementById(s));var r="boolean"==typeof n?n:"hidden"!=s.type,c=s.id,d=s.getAttribute("data-mq")||"";if(!0===r){var m=e(s).attr("type","hidden").val();t.hasOwnProperty("toMQ")&&(m=t.toMQ(m,c));var h=e("#mqinput-"+c);if(0==h.length){var p,f=e("<span/>",{id:"mqinput-"+c,class:"mathquill-math-field",text:m,"aria-label":s.getAttribute("aria-label")});null!==(p=s.className.match(/(ansred|ansyel|ansgrn|ansorg)/))&&f.addClass(p[0]),d.match(/chem/)&&f.addClass("mq-chem");var b=s.hasAttribute("size")?s.size>3?s.size/1.8:s.size:10;f.css("min-width",b+"em"),f.insertAfter(s);var v={handlers:{edit:y,enter:g}};t.hasOwnProperty("getLayoutstyle")?t.curlayoutstyle=t.getLayoutstyle():"auto"==t.layoutstyle?t.curlayoutstyle=q():t.curlayoutstyle=t.layoutstyle,"OSK"==t.curlayoutstyle&&(v.substituteTextarea=function(){var e=document.createElement("span");return e.setAttribute("tabindex",0),e},v.keyboardPassthrough=!0),d.match(/chem/)&&(v.charsThatBreakOutOfSupSubVar="",v.charsThatBreakOutOfSupSubOp="",v.autoSubscriptNumerals=!0),d.match(/(list|ntuple)/)&&(v.charsThatBreakOutOfSupSub="=<>,"),d.match(/allowplusminus/)&&(v.quickplusminus=!0),v.autoOperatorNames=v.autoParenOperators="ln log abs exp sin cos tan arcsinh arccosh arctanh arcsech arccsch arccoth argsinh argcosh argtanh argsech argcsch argcoth arsinh arcosh artanh arsech arcsch arcoth arcsin arccos arctan sec csc cot arcsec arccsc arccot sinh cosh sech csch tanh coth",v.autoCommands="pi theta root sqrt ^oo degree",d.match(/logic/)&&(v.autoCommands+=" neg xor or and implies iff"),d.match(/setexp/)&&(v.autoCommands+=" nn xor uu ominus cap cup oplus");var w,C=s.getAttribute("data-mq-vars")||"";if(""!=C){C=""==C?[]:C.split(/,/);for(var k=0;k<C.length;k++){w=C[k].split(/_/);for(var O=0;O<w.length;O++)w[O].length>1&&w[O].match(/^[a-zA-Z]+$/)&&(-1!=i.indexOf(w[O].toLowerCase())?v.autoCommands+=" "+w[O]:v.autoOperatorNames+=" "+w[O])}}s.disabled?(h=l.StaticMath(f[0]),f.addClass("disabled")):(h=l.MathField(f[0],v).config(a),u(f),e(s).on("change.mqed",(function(e,a){if(!a){var n=s.value;t.hasOwnProperty("toMQ")&&(n=t.toMQ(n,s.id)),h.latex(n)}})))}else h.show(),h=l(h[0]).latex(m);!0!==o&&h.focus()}else e(s).attr("type","text").off("change.mqed"),!0!==o&&e(s).focus(),e("#mqinput-"+c).hide()}function u(a){e(a).find(".mq-textarea > *").on("focus.mqeditor",h).on("blur.mqeditor",(function(){o=setTimeout(p,100),t.hasOwnProperty("onBlur")&&t.onBlur()})),e(a).on("click.mqeditor",(function(t){var a=e(t.target).closest("label");if(a.length>0)return"undefined"!==a.attr("for")&&e("#"+a.attr("for")).prop("checked",!0),t.stopPropagation(),!1}))}function h(a){clearTimeout(o);var r=e(a.target).closest(".mathquill-math-field");!1===s&&(e("body").append(e("<div/>",{id:"mqeditor",class:"mqeditor"})),e("#mqeditor").on("mousedown touchstart",(function(e){e.preventDefault()})),s=!0);var i=t.curlayoutstyle;if(t.hasOwnProperty("getLayoutstyle")?t.curlayoutstyle=t.getLayoutstyle():"auto"==t.layoutstyle?t.curlayoutstyle=q():t.curlayoutstyle=t.layoutstyle,"OSK"===t.curlayoutstyle){if(c()?e("#mqeditor").addClass("iframeosk").removeClass("fixedbottom"):e("#mqeditor").addClass("fixedbottom").removeClass("iframeosk"),!document.getElementById("mqe-fb-spacer")){var d=document.createElement("div");d.style.height="200px",d.id="mqe-fb-spacer",e("body").append(d)}}else e("#mqeditor").removeClass("fixedbottom iframeosk");e("#mqeditor").toggleClass("mq-chem",e(r).hasClass("mq-chem"));var m=!1;if((null===n||r[0]!=n.el()||i!==t.curlayoutstyle)&&(m=!0,null!==n&&e("#"+n.el().id.substring(8)).trigger("change",!0),t.hasOwnProperty("getLayout")&&(t.layout=t.getLayout(r[0],t.curlayoutstyle)),e("#mqeditor").empty().show(),t.layout.tabs?function(t,a,s){var n=document.createElement("div");n.className="mqed-row mqed-tabrow";var o,r,l=document.createElement("div");t.appendChild(n),t.appendChild(l);for(var i=0;i<a.tabs.length;i++)if(!0===a.tabs[i].enabled){v(n,a.tabs[i],s+"-"+i),(r=document.createElement("div")).className="mqed-row mqed-tabpanel",r.id=s+"-"+i+"-tabpanel",l.appendChild(r);for(var c=0;c<a.tabs[i].tabcontent.length;c++)(o=a.tabs[i].tabcontent[c]).hasOwnProperty("flow")&&0==o.contents.length||(o.hasOwnProperty("flow")?b(r,o,s+"-"+i+"-"+c):v(r,o,s+"-"+i+"-"+c))}v(n,{s:1}),v(n,{p:"&times;",c:"close",lb:"close"}),e(t).find(".mqed-tab").first().addClass("mqed-activetab")}(document.getElementById("mqeditor"),t.layout,"mqeditor"):b(document.getElementById("mqeditor"),t.layout,"mqeditor"),e("#mqeditor .mqed-btn.rend").each((function(){l.StaticMath(this,{mouseEvents:!1})})),e("#mqeditor .mqed-tabrow").length>0)){e("#mqeditor .mqed-tabpanel").hide().first().show();var u=e("#mqeditor .mqed-tabrow + div");u.css("height",u.height())}"OSK"!==t.curlayoutstyle||c()?e("#mqeditor").show():e("#mqeditor").slideDown(50,(function(){var t=e("#mqeditor").height()+5,a=e(window).height()-(r.offset().top+r.outerHeight()-e(window).scrollTop());a<t&&e(window).scrollTop(e(window).scrollTop()+(t-a))})),f(r),n=l.MathField(r[0]),e("#"+r[0].id.substring(8)).triggerHandler("focus"),t.hasOwnProperty("onShow")&&t.onShow(r[0],t.curlayoutstyle,m),e(document).trigger("mqeditor:show")}function p(a){n&&(e(document).trigger("mqeditor:hide"),"OSK"!==t.curlayoutstyle||c()?e("#mqeditor").hide():e("#mqeditor").slideUp(50),e("#"+n.el().id.substring(8)).trigger("change",!0),n=null)}function f(a){if("under"==t.curlayoutstyle||c()){var s=e(a).closest(".mathquill-math-field"),n=s.offset(),o=s.outerHeight(),r=n.left;if(document.getElementById("mqeditor")){var l=document.getElementById("mqeditor").offsetWidth;r+l>document.documentElement.clientWidth&&(r=document.documentElement.clientWidth-l-5)}c()?e("#mqeditor").css("top",n.top+o+3).css("left",0):e("#mqeditor").css("top",n.top+o+3).css("left",r)}else e("#mqeditor").css("top","auto").css("left",0)}function y(a){var s=a.el();if(f(s),t.hasOwnProperty("onResize")&&t.onResize(s,t.curlayoutstyle),s.id.match(/mqinput/)){var n=a.latex();t.hasOwnProperty("fromMQ")&&(n=t.fromMQ(n,s.id)),e("#"+s.id.substring(8)).val(n).trigger("input"),""!=n&&e("#"+s.id.substring(8)).siblings("input[id^=qs][value=spec]").prop("checked",!0),t.hasOwnProperty("onEdit")&&t.onEdit(s.id,n)}}function g(e){t.hasOwnProperty("onEnter")&&t.onEnter(e.el().id)}function q(){var e=document.documentElement.clientWidth;return navigator.userAgent.match(/Android/)||navigator.userAgent.match(/iPhone/)||navigator.userAgent.match(/iPad/)||e<500?"OSK":"under"}function b(e,t,a){var s=t.flow,n=100;t.hasOwnProperty("s")&&"row"==s&&(n=t.s);var o=document.createElement("div");t.hasOwnProperty("s")&&(o.style.flexGrow=t.s),t.hasOwnProperty("class")&&(o.className=t.class),t.hasOwnProperty("tabpanel")&&(o.id=t.tabpanel.id,o.style.display=t.tabpanel.hidden?"none":""),(d=document.createElement("div")).className="mqed-"+s;for(var r,l=0,i=0,c=0;c<t.contents.length;c++)if(!(r=t.contents[c]).hasOwnProperty("flow")||0!=r.contents.length){var d;if(l+(i=r.hasOwnProperty("s")?r.s:1)>n)o.appendChild(d),l=0,(d=document.createElement("div")).className="mqed-"+s;r.hasOwnProperty("flow")?b(d,r,a+"-"+c):v(d,r,a+"-"+c),l+=i}o.appendChild(d),e.appendChild(o)}function v(t,a,s){var n,o,l,i;if((o=document.createElement("div")).className="mqed-btn-cont",a.s&&(o.style.flexGrow=a.s),a.contid&&(o.id=a.contid),a.contclass&&e(o).addClass(a.contclass),t.appendChild(o),a.l||a.b||a.p){if((n=document.createElement("span")).tabIndex=0,a.l){if(a.op)n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-root-block"><var class="mq-operator-name">'+a.l.substring(1)+"</var></span>";else if(a.pr)n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-root-block">'+a.pr+"</span>";else if(a.l.match(/\\left(.)\\right(.)/)){var c=a.l.match(/\\left(.)\\right(.)/);n.className="mqed-btn mq-math-mode",n.innerHTML='<span class="mq-non-leaf"><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+c[1]+'</span><span class="mq-non-leaf mq-empty"></span><span class="mq-scaled mq-paren" style="transform: scale(1, 1.2);">'+c[2]+"</span></span>"}else n.className="mqed-btn rend",n.innerText=a.l;l="c",i=a.l.substring(1)}else a.b?(a.r?(n.className="mqed-btn rend",n.innerHTML=a.b):(n.className="mqed-btn mq-math-mode",a.v?n.innerHTML='<span class="mq-root-block"><var>'+a.b+"</var></span>":n.innerHTML='<span class="mq-root-block"><span>'+a.b+"</span></span>"),l="t",((i=a.b).match(/^\d$/)||"."==i)&&e(n).addClass("mqed-digitkey")):(n.className="mqed-btn",n.innerHTML=a.p,l="t",i=a.p);a.c&&("shift"==(l=a.c)?e(n).addClass("mqed-shift"):"k"==l?e(n).addClass("mqed-navkey"):"close"==l&&e(n).addClass("mqed-closebtn")),a.lb&&n.setAttribute("aria-label",a.lb),a.sm&&(n.style.fontSize=100-10*a.sm+"%"),a.w&&(i=a.w),a.tabcontent&&(e(n).addClass("mqed-tab"),l="showtabpanel",i=s+"-tabpanel"),e(n).data("cmdtype",l).data("cmdval",i),e(n).on("click mousedown touchstart keydown",function(e,t){return function(a){w(a,e,t)}}(l,i)).on("touchend",(function(t){setTimeout((function(){e(t.currentTarget).removeClass("mactive")}),50)})).on("touchend mouseup",(function(){clearTimeout(r),r=null})),o.appendChild(n)}}function w(a,s,o){if(("mousedown"!=a.type||"Backspace"===o)&&!("click"==a.type&&"Backspace"===o||"keydown"==a.type&&"Enter"!==a.key))if("touchstart"==a.type&&(a.preventDefault(),e(a.currentTarget).addClass("mactive")),"t"==s)o.match(/^[a-zA-Z]$/)&&e(a.target).closest(".mqed-tabpanel").find(".mqed-shift").hasClass("active")&&(o=o.toUpperCase()),n.typedText(o);else if("c"==s)n.cmd(o);else if("l"==s)n.latex(o);else if("w"==s){if(n.write(o),m=o.match(/bmatrix}(.*?)(\\\\|\\end{bm)/))for(var l=m[1].split(/&/).length,i=0;i<l;i++)n.keystroke("Left")}else if("k"==s)n.keystroke(o),"Backspace"===o&&(r=setTimeout((function(){w(a,s,o)}),null===r?600:70));else if("m"==s)n.matrixCmd(o);else if("f"==s){(c=n.getSelection())?(n.write(o+"\\left("+c+"\\right)"),n.keystroke("Left")):o.match(/{}$/)?n.typedText(o.replace(/{}$/,"")):n.write(o)}else if("sf"==s){(c=n.getSelection())?n.write(o+"{"+c+"}"):n.cmd(o),n.keystroke("Left")}else if("i"==s){var c;if((c=n.getSelection())||(c=""),"string"==typeof o){var d=o.charAt(0),u=o.charAt(1);n.write("\\left"+d+c+"\\right"+u)}else n.write(o[0]+c+o[1]);""==c&&n.keystroke("Left")}else if("showtabpanel"==s){(h=e(a.target).closest(".mqed-btn")).closest(".mqeditor").find(".mqed-tabpanel").hide(),h.closest(".mqeditor").find(".mqed-btn.mqed-activetab").removeClass("mqed-activetab"),e("#"+o).show(),h.addClass("mqed-activetab"),t.hasOwnProperty("onTab")&&t.onTab(h[0],t.curlayoutstyle,o)}else if("shift"==s){var h=e(a.target).closest(".mqed-btn"),p=e(a.target).closest(".mqed-tabpanel"),f=!h.hasClass("active");f?h.addClass("active"):h.removeClass("active"),p.find(".mqed-btn").each((function(e,t){t.textContent.match(/^[a-zA-Z]$/)&&(t.textContent=f?t.textContent.toUpperCase():t.textContent.toLowerCase())}))}else"close"==s&&n.blur()}return{setConfig:function(e){for(var a in e)t[a]=e[a]},setMQconfig:function(e){a=e},toggleMQ:d,toggleMQAll:function(t,a){var s=a||null;e(t).each((function(e,t){d(t,s,!0)}))},attachEditor:u,getLayoutstyle:q,resetEditor:function(){clearTimeout(o),e("#mqeditor").hide(),n=null}}}(jQuery);